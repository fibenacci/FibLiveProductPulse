{% sw_extends '@Storefront/storefront/component/buy-widget/buy-widget.html.twig' %}

{% block buy_widget_delivery_informations %}
    {% set fibLiveProductPulseShowStock = config('FibLiveProductPulse.config.showStockFeatureOnPdp') %}
    {% set fibLiveProductPulseShowViewer = config('FibLiveProductPulse.config.showViewerFeatureOnPdp') %}

    {% set fibLiveProductPulseStockOptions = {
        stockFeatureEnabled: fibLiveProductPulseShowStock is not same as(false),
        stockStateEndpoint: fibLiveProductPulseShowStock is not same as(false) ? path('frontend.fib.live_product_pulse.stock_state', { productId: product.id }) : null,
        cartPresenceHeartbeatEndpoint: fibLiveProductPulseShowStock is not same as(false) ? path('frontend.fib.live_product_pulse.cart_presence_heartbeat') : null,
        cartPresenceLeaveEndpoint: fibLiveProductPulseShowStock is not same as(false) ? path('frontend.fib.live_product_pulse.cart_presence_leave') : null,
        pollIntervalMs: config('FibLiveProductPulse.config.pollIntervalMs') ?: 4000,
        backgroundPollIntervalMs: config('FibLiveProductPulse.config.backgroundPollIntervalMs') ?: 15000,
        requestTimeoutMs: config('FibLiveProductPulse.config.requestTimeoutMs') ?: 4000,
        maxBackoffMs: config('FibLiveProductPulse.config.maxBackoffMs') ?: 60000,
        jitterRatio: ((config('FibLiveProductPulse.config.jitterPercent') ?: 15) / 100),
        statusTexts: {
            available: 'fib-live-product-pulse.storefront.status.available'|trans|sw_sanitize,
            soldout: 'fib-live-product-pulse.storefront.status.soldout'|trans|sw_sanitize,
            reserved: 'fib-live-product-pulse.storefront.status.reserved'|trans|sw_sanitize,
            restock: 'fib-live-product-pulse.storefront.status.restock'|trans|sw_sanitize,
            preorder: 'fib-live-product-pulse.storefront.status.preorder'|trans|sw_sanitize,
            notAvailable: 'fib-live-product-pulse.storefront.status.notAvailable'|trans|sw_sanitize
        }
    } %}

    {% set fibLiveProductPulseViewerOptions = {
        viewerFeatureEnabled: fibLiveProductPulseShowViewer is not same as(false),
        viewerEndpoint: fibLiveProductPulseShowViewer is not same as(false) ? path('frontend.fib.live_product_pulse.viewers', { productId: product.id }) : null,
        viewerLeaveEndpoint: fibLiveProductPulseShowViewer is not same as(false) ? path('frontend.fib.live_product_pulse.viewers_leave', { productId: product.id }) : null,
        pollIntervalMs: config('FibLiveProductPulse.config.pollIntervalMs') ?: 4000,
        backgroundPollIntervalMs: config('FibLiveProductPulse.config.backgroundPollIntervalMs') ?: 15000,
        requestTimeoutMs: config('FibLiveProductPulse.config.requestTimeoutMs') ?: 4000,
        maxBackoffMs: config('FibLiveProductPulse.config.maxBackoffMs') ?: 60000,
        jitterRatio: ((config('FibLiveProductPulse.config.jitterPercent') ?: 15) / 100),
        clientTokenStorageKey: 'fib-live-product-pulse-client-token',
        viewerTexts: {
            zero: 'fib-live-product-pulse.storefront.viewers.zero'|trans|sw_sanitize,
            one: 'fib-live-product-pulse.storefront.viewers.one'|trans|sw_sanitize,
            many: 'fib-live-product-pulse.storefront.viewers.many'|trans|sw_sanitize
        }
    } %}

    <div class="fib-live-product-pulse">
        <div class="product-detail-delivery-information"
             {% if fibLiveProductPulseShowStock is not same as(false) %}
                 data-fib-live-product-pulse-stock="true"
                 data-fib-live-product-pulse-stock-options="{{ fibLiveProductPulseStockOptions|json_encode|escape('html_attr') }}"
             {% endif %}
        >
            {% sw_include '@Storefront/storefront/component/delivery-information.html.twig' %}
        </div>

        {% if fibLiveProductPulseShowViewer is not same as(false) %}
            <p class="delivery-information fib-live-product-pulse-viewers"
               data-fib-live-product-pulse-viewer="true"
               data-fib-live-product-pulse-viewer-options="{{ fibLiveProductPulseViewerOptions|json_encode|escape('html_attr') }}"
               hidden>
                <span class="delivery-status-indicator bg-info"></span>
                <span data-fib-live-product-pulse-viewers-text></span>
            </p>
        {% endif %}
    </div>
{% endblock %}
